import{a as q}from"./chunk-W3UWONK4.js";import{c as G,e as K,f as X,h as Y,j as Z,k as ee,v as te}from"./chunk-VT7537MC.js";import{a as ie}from"./chunk-IMCIWAYF.js";import"./chunk-NUY3BYMQ.js";import{g as Q}from"./chunk-KBS3EZNC.js";import{h as j,i as J,j as D,l as z,n as H,s as v,t as L}from"./chunk-SBNREMTY.js";import{$ as y,Bb as P,Cb as O,Db as U,Fb as h,Gb as g,Kb as S,Lb as T,Mb as M,Oa as w,Ob as W,Qb as F,Sb as k,Tb as $,Ua as s,Vb as B,ba as R,db as p,eb as V,fb as m,hb as f,jb as C,kb as E,la as u,lb as N,ma as d,mb as A,nb as r,ob as l,pb as x,sb as b,vb as _,wb as a,zb as I}from"./chunk-IC3SXG5R.js";var ae=["scrollContainer"],ne=i=>({hidden:i}),oe=(i,c,e)=>({"bg-custom-blue":i,"hover:!bg-dark-blue":c,"text-white":e});function re(i,c){if(i&1&&(r(0,"app-notification"),h(1),l()),i&2){let e=a();V("role",e.notification.status),s(),g(e.notification.message)}}function le(i,c){i&1&&x(0,"app-loader")}function ce(i,c){if(i&1&&x(0,"img",18),i&2){let e=a(2).$implicit;I("alt","",e==null?null:e.image," ",e==null?null:e.image,""),m("src",e==null?null:e.image,w)}}function he(i,c){if(i&1&&(r(0,"div",19),h(1),l()),i&2){let e=a(2).$implicit;s(),g((e==null?null:e.first_name[0].toUpperCase())+e.last_name[0].toUpperCase())}}function ue(i,c){if(i&1){let e=b();r(0,"li",17),_("click",function(){u(e);let t=a().$implicit,o=a(2);return d(o.getChatWithSomeone(t.id))})("click",function(){u(e);let t=a(3);return d(t.onChangeChatAgain())}),p(1,ce,1,4,"img",18)(2,he,2,1,"div",19),r(3,"div",20),h(4),l()()}if(i&2){let e=a().$implicit,n=a(2);f("bg-chat",n.receiverId===(e==null?null:e.id)),s(),C(e.image?1:2),s(3),g((e==null?null:e.first_name)+" "+(e==null?null:e.last_name))}}function de(i,c){if(i&1&&p(0,ue,5,4,"li",16),i&2){let e=c.$implicit,n=a(2);C(n.chatType==e.type?0:-1)}}function me(i,c){if(i&1&&x(0,"img",18),i&2){let e=a(3);I("alt","",e.userChat==null?null:e.userChat.image," ",e.userChat==null?null:e.userChat.image,""),m("src",e.userChat==null?null:e.userChat.image,w)}}function pe(i,c){if(i&1&&(r(0,"div",19),h(1),l()),i&2){let e=a(3);s(),g((e.userChat==null?null:e.userChat.first_name[0].toUpperCase())+e.userChat.last_name[0].toUpperCase())}}function ge(i,c){if(i&1&&(r(0,"div",21),p(1,me,1,4,"img",18)(2,pe,2,1,"div",19),r(3,"p",22),h(4),l()()),i&2){let e=a(2);s(),C(e.userChat.image?1:2),s(3),g(e.userChat.first_name+" "+e.userChat.last_name)}}function Ce(i,c){if(i&1&&(r(0,"div",23)(1,"div",24),h(2),l(),r(3,"div",25),h(4),$(5,"date"),l()()),i&2){let e=c.$implicit;f("ml-auto",e==null?null:e.is_mine),s(),f("bg-custom-blue",e==null?null:e.is_mine)("bg-white",!(e!=null&&e.is_mine)),s(),g(e==null?null:e.message),s(),f("text-end",e==null?null:e.is_mine)("text-start",!(e!=null&&e.is_mine)),s(),g(B(5,12,e==null?null:e.sent_at,"dd MMMM - HH:mm"))}}function _e(i,c){if(i&1){let e=b();r(0,"form",26),_("submit",function(){u(e);let t=a(2);return d(t.sendMessage())}),r(1,"input",27),M("ngModelChange",function(t){u(e);let o=a(2);return T(o.newMessage,t)||(o.newMessage=t),d(t)}),l(),r(2,"button",28),h(3,"Send"),l()()}if(i&2){let e=a(2);s(),S("ngModel",e.newMessage)}}function fe(i,c){if(i&1){let e=b();r(0,"div",1)(1,"div",2),_("click",function(){u(e);let t=a();return d(t.onchatMobileChange())}),x(2,"i",3),l(),r(3,"div",4)(4,"div",5)(5,"ul",6)(6,"li",7)(7,"input",8),_("keyup",function(){u(e);let t=a();return d(t.onSearchContractor())}),M("ngModelChange",function(t){u(e);let o=a();return T(o.searchTerm,t)||(o.searchTerm=t),d(t)}),l()(),r(8,"li",9)(9,"button",10),_("click",function(){u(e);let t=a();return d(t.onChangeChatType("company"))}),h(10,"Company"),l(),r(11,"button",10),_("click",function(){u(e);let t=a();return d(t.onChangeChatType("user"))}),h(12,"User"),l()(),N(13,de,1,1,null,null,E),l()()(),r(15,"div",11),p(16,ge,5,2,"div",12),r(17,"div",13,0),p(19,Ce,6,15,"div",14),l(),p(20,_e,4,1,"form",15),l()()}if(i&2){let e=a();s(),f("bg-white",e.chatMobileChange),s(2),m("ngClass",F(10,ne,e.chatMobileChange)),s(4),S("ngModel",e.searchTerm),s(2),m("ngClass",k(12,oe,e.chatType=="company",e.chatType=="company",e.chatType=="company")),s(2),m("ngClass",k(16,oe,e.chatType=="user",e.chatType=="user",e.chatType=="user")),s(2),A(e.contactorsFiltered),s(2),m("ngClass",F(20,ne,!e.chatMobileChange)),s(),m("ngIf",e.userChat),s(3),m("ngForOf",e.messages),s(),C(e.userChat?20:-1)}}var Ve=(()=>{class i{currentUserId;receiverId;newMessage="";messages=[];statusMessage="";statusClasses="";base_API="https://c.jordanwebmaster.com/flexihire/public/api/chat";token;contactors=[];user=null;userChat;searchTerm="";contactorsFiltered=[];chatType;chatMobileChange=!1;loading=!1;notification={isFound:!1,message:"",status:""};pusher;channel;http=y(L);router=y(Q);scrollContainer;ngOnInit(){this.user=sessionStorage.getItem("userChat")?JSON.parse(sessionStorage.getItem("userChat")):null,localStorage.getItem("user")&&(this.token=JSON.parse(localStorage.getItem("user")).token,this.currentUserId=JSON.parse(localStorage.getItem("user")).user.id),sessionStorage.getItem("receiverId")&&(this.receiverId=JSON.parse(sessionStorage.getItem("receiverId")),console.log("receiverId of sessionStorage",this.receiverId),this.getChatWithSomeone(this.receiverId)),(this.user!=null||this.user!=null)&&(console.log("this.user",this.user),this.receiverId=this.user.id,sessionStorage.setItem("receiverId",this.receiverId.toString()),console.log("receiverId of user",this.receiverId),this.getChatWithSomeone(this.receiverId),sessionStorage.removeItem("userChat")),sessionStorage.getItem("chatType")?this.chatType=sessionStorage.getItem("chatType"):this.chatType="company",sessionStorage.getItem("chatMobileChange")&&(this.chatMobileChange=JSON.parse(sessionStorage.getItem("chatMobileChange")),sessionStorage.removeItem("chatMobileChange"),console.log(this.chatMobileChange)),this.getContactors()}ngOnDestroy(){this.pusher&&this.pusher.disconnect()}connect(){this.initPusher(),this.messages=[]}initPusher(){this.pusher&&this.pusher.disconnect(),this.pusher=new Pusher("1592f4180794c697061f",{cluster:"eu",authEndpoint:"https://c.jordanwebmaster.com/flexihire/public/api/broadcasting/auth",auth:{headers:{Authorization:`Bearer ${this.token}`,Accept:"application/json"}},encrypted:!0}),this.pusher.connection.bind("connected",()=>{this.subscribeToChannel()}),this.pusher.connection.bind("error",e=>{let n=e?.message||JSON.stringify(e)||"Unknown error";this.notification={isFound:!0,message:n,status:"alert"},setTimeout(()=>{this.notification={isFound:!1,message:"",status:""}},3500)})}subscribeToChannel(){let e=Math.min(this.currentUserId,this.receiverId),n=Math.max(this.currentUserId,this.receiverId),t=`chat.${e}-${n}`;this.channel=this.pusher.subscribe(t),this.channel.bind("pusher:subscription_succeeded",()=>{}),this.channel.bind("pusher:subscription_error",o=>{let se=o?.message||o?.error||JSON.stringify(o)||"Unknown error";this.notification={isFound:!0,message:se,status:"alert"},setTimeout(()=>{this.notification={isFound:!1,message:"",status:""}},3500)}),this.channel.bind("new.message",o=>{this.receiverId===o.from_id&&(this.addMessage(o.message,!1,o,new Date(o.timestamp)),console.log("receiver is",o))})}sendMessage(){let e=this.newMessage.trim();if(this.user&&this.messages.length==0&&(e="Welcome in a New Chat"),this.newMessage="",!e||!this.receiverId)return;let n=new v({Authorization:`Bearer ${this.token}`,Accept:"application/json"});this.http.post(`${this.base_API}/send-chat/${this.receiverId}`,{message:e},{headers:n}).subscribe({next:t=>{console.log("sender is",t),this.addMessage(e,!0,t.data.sender,new Date),this.user&&(this.getContactors(),sessionStorage.removeItem("userChat"),this.user=null,console.log("this.user",this.user))},error:t=>{this.notification={isFound:!0,message:t.message||"Error fetching applications",status:"alert"},setTimeout(()=>{this.notification={isFound:!1,message:"",status:""}},3500),console.error(t)}})}onChangeChatAgain(){this.chatMobileChange||this.onchatMobileChange()}addMessage(e,n,t,o){this.messages.push({message:e,is_mine:n,sender:t,sent_at:o}),this.messages=[...this.messages],this.scrollToBottom()}getChatWithSomeone(e){this.receiverId=e,console.log(this.receiverId),sessionStorage.setItem("receiverId",this.receiverId.toString()),this.connect();let n=new v({Authorization:`Bearer ${this.token}`,Accept:"application/json"});this.loading=!0,this.http.get(`${this.base_API}/get-chat/${this.receiverId}`,{headers:n}).subscribe({next:t=>{console.log(t),this.messages=t.messages,console.log("this.messages",this.messages),this.loading=!1,this.user&&this.messages.length==0&&(this.newMessage="Welcome in a New Chat",this.sendMessage()),this.contactors.forEach(o=>{o.id==this.receiverId&&(this.userChat=o)}),console.log(this.receiverId),console.log("this.userChat",this.userChat),this.scrollToBottom()},error:t=>{console.error(t),this.loading=!1}})}getContactors(){let e=new v({Authorization:`Bearer ${this.token}`,Accept:"application/json"});this.loading=!0,this.http.get(this.base_API+"/contacts",{headers:e}).subscribe({next:n=>{console.log(n),this.loading=!1,this.contactors=n.contacts,this.contactorsFiltered=this.contactors,this.contactors.forEach(t=>{t.id==this.receiverId&&(this.userChat=t)})},error:n=>{console.error(n)}})}onChangeChatType(e){this.chatType=e,sessionStorage.setItem("chatType",this.chatType)}scrollToBottom(){try{setTimeout(()=>{this.scrollContainer?.nativeElement&&(this.scrollContainer.nativeElement.scrollTop=this.scrollContainer.nativeElement.scrollHeight)},100)}catch{}}onSearchContractor(){this.searchTerm.length>0?this.contactorsFiltered=this.contactors.filter(e=>(e.first_name+" "+e.last_name).toLowerCase().includes(this.searchTerm.toLowerCase())):this.contactorsFiltered=this.contactors}onchatMobileChange(){this.chatMobileChange=!this.chatMobileChange,sessionStorage.setItem("chatMobileChange",JSON.stringify(this.chatMobileChange))}static \u0275fac=function(n){return new(n||i)};static \u0275cmp=R({type:i,selectors:[["app-real-chat"]],viewQuery:function(n,t){if(n&1&&P(ae,5),n&2){let o;O(o=U())&&(t.scrollContainer=o.first)}},standalone:!0,features:[W],decls:3,vars:2,consts:[["scrollContainer",""],[1,"grid","grid-cols-1","md:grid-cols-5","lg:grid-cols-4","bg-white","rounded","h-[calc(100vh-52px)]","lg:h-[calc(100vh-72px)]"],[1,"fixed","py-2","px-3","border-2","border-custom-blue","md:hidden","bg-custom-blue","rounded-full","right-5","top-14","cursor-pointer",3,"click"],[1,"fa-solid","fa-list"],[1,"md:col-span-2","lg:col-span-1","flex","md:!flex","flex-col","h-full","bg-white","rounded","shadow-md","overflow-y-auto",3,"ngClass"],[1,"overflow-y-auto","flex-grow"],[1,"list-none","p-0","m-0"],[1,"p-5","pb-0"],["type","text","placeholder","Search...",1,"!p-3","!rounded-full","!border-2","!border-custom-blue","focus:outline-none","focus:border-custom-blue",3,"keyup","ngModelChange","ngModel"],[1,"flex","justify-around","pb-3"],[1,"border-custom-blue","border-2","py-2","px-7","rounded-full","text-gray-500","hover:bg-gray-100",3,"click","ngClass"],[1,"chat-section","md:col-span-3","flex","md:!flex","flex-col","h-full","bg-chat","rounded","shadow-md","overflow-y-auto",3,"ngClass"],["class","bg-white flex gap-x-2 items-center p-3 rounded-b-3xl",4,"ngIf"],[1,"overflow-y-auto","p-4","bg-chat","flex-grow"],["class","w-fit",3,"ml-auto",4,"ngFor","ngForOf"],[1,"flex","gap-2","p-5","bg-[#F4F9FA]","rounded-t-3xl"],[1,"p-3","cursor-pointer","border-b-[1px]","transition","duration-200","ease-in-out","flex","items-center","gap-x-2",3,"bg-chat"],[1,"p-3","cursor-pointer","border-b-[1px]","transition","duration-200","ease-in-out","flex","items-center","gap-x-2",3,"click"],[1,"w-12","rounded-full",3,"src","alt"],[1,"w-12","h-12","rounded-full","bg-gray-200","flex","items-center","justify-center","text-xl","font-semibold","text-gray-600"],[1,"text-lg","text-black","font-bold"],[1,"bg-white","flex","gap-x-2","items-center","p-3","rounded-b-3xl"],[1,"font-bold"],[1,"w-fit"],[1,"mb-3","py-2","px-3","rounded-xl"],[1,"text-xs","text-gray-500","mt-1"],[1,"flex","gap-2","p-5","bg-[#F4F9FA]","rounded-t-3xl",3,"submit"],["type","text","name","message","placeholder","Type a message...",1,"flex-1","!m-0","!border-2","!border-custom-blue","!rounded-full",3,"ngModelChange","ngModel"],["type","submit",1,"bg-custom-blue","rounded-full","text-white","px-4","py-2","hover:bg-dark-blue"]],template:function(n,t){n&1&&p(0,re,2,2,"app-notification")(1,le,1,0,"app-loader")(2,fe,21,22,"div",1),n&2&&(C(t.notification.isFound?0:-1),s(),C(t.loading?1:2))},dependencies:[H,j,J,D,z,te,ee,G,K,X,Z,Y,ie,q],styles:[".bg-chat[_ngcontent-%COMP%]{background-color:#eee}"]})}return i})();export{Ve as RealChatComponent};
